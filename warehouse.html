<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Ti·ªám Thu·ªëc T·ª± ƒê·ªông - Kho H√†ng</title>
    <link rel="stylesheet" href="./public/css/warehouse.css?v=1.1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="#">üíä PharmaCare</a>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="./home.html" onclick="setActive(this)">üè† Trang ch·ªß</a>
        </li>
        <li>
          <a href="./warehouse.html" onclick="setActive(this)">üì¶ Kho thu·ªëc</a>
        </li>
        <li>
          <a href="./products.html" onclick="setActive(this)">üìù ƒê∆°n thu·ªëc</a>
        </li>
        <li>
          <a href="./employees.html" onclick="setActive(this)">üë• Nh√¢n vi√™n</a>
        </li>
        <li><a href="./checkout.html" onclick="setActive(this)">üí≥ Thanh to√°n</a></li>
        <li>
          <a href="./reports.html" onclick="setActive(this)">üìà B√°o c√°o & Th·ªëng k√™</a>
        </li>
        <li>
          <a href="./warning.html" onclick="setActive(this)">ü§ñ Chatbox c·∫£nh b√°o</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
  <main>
    <h1>Kho thu·ªëc</h1>
    <div class="warehouse-actions">
      <button class="add-button">+ Th√™m m·ªõi</button>
      <div class="search-bar">
        <input type="text" id="warehouseSearchInput" placeholder="Search..." />
        <button id="warehouseSearchBtn"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="table-container">
      <table class="medicine-table">
        <thead>
          <tr>
            <th>·∫¢nh</th>
            <th>M√£ thu·ªëc</th>
            <th>T√™n thu·ªëc</th>
            <th>ƒê∆°n v·ªã</th>
            <th>Gi√° nh·∫≠p</th>
            <th>Gi√° b√°n</th>
            <th>Ng√†y th√™m</th>
            <th>S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu</th>
            <th>H·∫°n s·ª≠ d·ª•ng</th>
            <th>M√£ l√¥</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="warehouseTableBody">
          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
        </tbody>
      </table>
    </div>
    <div class="pagination" id="warehousePagination"></div>

    <!-- Modal th√™m thu·ªëc m·ªõi -->
    <div id="addMedicineModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Th√™m thu·ªëc m·ªõi</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="addMedicineForm">
            <div class="form-row">
              <div class="form-group">
                <label for="medicineImage">·∫¢nh:</label>
                <input type="file" id="medicineImage" accept="image/*" />
              </div>
              <div class="form-group">
                <label for="medicineCode">M√£ thu·ªëc:</label>
                <input type="text" id="medicineCode" placeholder="Nh·∫≠p m√£ thu·ªëc" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="medicineName">T√™n thu·ªëc:</label>
                <input type="text" id="medicineName" placeholder="Nh·∫≠p t√™n thu·ªëc" />
              </div>
              <div class="form-group">
                <label for="medicineUnit">ƒê∆°n v·ªã:</label>
                <input type="text" id="medicineUnit" placeholder="Nh·∫≠p ƒë∆°n v·ªã" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="importPrice">Gi√° nh·∫≠p:</label>
                <input type="number" id="importPrice" placeholder="Nh·∫≠p gi√° nh·∫≠p" />
              </div>
              <div class="form-group">
                <label for="salePrice">Gi√° b√°n:</label>
                <input type="number" id="salePrice" placeholder="Nh·∫≠p gi√° b√°n" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="addDate">Ng√†y th√™m:</label>
                <input type="date" id="addDate" />
              </div>
              <div class="form-group">
                <label for="minQuantity">S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu:</label>
                <input type="number" id="minQuantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="expiryDate">H·∫°n s·ª≠ d·ª•ng:</label>
                <input type="date" id="expiryDate" />
              </div>
              <div class="form-group">
                <label for="batchCode">M√£ l√¥:</label>
                <input type="text" id="batchCode" placeholder="Nh·∫≠p m√£ l√¥" />
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-primary" onclick="saveMedicine()">L∆∞u</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal ch·ªânh s·ª≠a thu·ªëc -->
    <div id="editMedicineModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Ch·ªânh s·ª≠a thu·ªëc</h2>
          <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editMedicineForm">
            <div class="form-row">
              <div class="form-group">
                <label for="editMedicineImage">·∫¢nh:</label>
                <input type="file" id="editMedicineImage" accept="image/*" />
              </div>
              <div class="form-group">
                <label for="editMedicineCode">M√£ thu·ªëc:</label>
                <input type="text" id="editMedicineCode" placeholder="Nh·∫≠p m√£ thu·ªëc" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editMedicineName">T√™n thu·ªëc:</label>
                <input type="text" id="editMedicineName" placeholder="Nh·∫≠p t√™n thu·ªëc" />
              </div>
              <div class="form-group">
                <label for="editMedicineUnit">ƒê∆°n v·ªã:</label>
                <input type="text" id="editMedicineUnit" placeholder="Nh·∫≠p ƒë∆°n v·ªã" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editImportPrice">Gi√° nh·∫≠p:</label>
                <input type="number" id="editImportPrice" placeholder="Nh·∫≠p gi√° nh·∫≠p" />
              </div>
              <div class="form-group">
                <label for="editSalePrice">Gi√° b√°n:</label>
                <input type="number" id="editSalePrice" placeholder="Nh·∫≠p gi√° b√°n" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editAddDate">Ng√†y th√™m:</label>
                <input type="date" id="editAddDate" />
              </div>
              <div class="form-group">
                <label for="editMinQuantity">S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu:</label>
                <input type="number" id="editMinQuantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editExpiryDate">H·∫°n s·ª≠ d·ª•ng:</label>
                <input type="date" id="editExpiryDate" />
              </div>
              <div class="form-group">
                <label for="editBatchCode">M√£ l√¥:</label>
                <input type="text" id="editBatchCode" placeholder="Nh·∫≠p m√£ l√¥" />
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-primary" onclick="updateMedicine()">L∆∞u</button>
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </body>
  <script src="./public/js/navbar.js"></script>
  <script src="./public/js/sidebar.js"></script>
  <script src="./backend/public/js/api.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('warehouseSearchInput');
      const tableBody = document.getElementById('warehouseTableBody');
      
      // Bi·∫øn qu·∫£n l√Ω ph√¢n trang
      let allMedicines = [];
      let currentPage = 1;
      const itemsPerPage = 10; // Hi·ªÉn th·ªã 10 d√≤ng m·ªói trang
      
      // Load d·ªØ li·ªáu thu·ªëc t·ª´ API khi trang load
      loadMedicineData();

      searchInput.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(keyword)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });

      // X·ª≠ l√Ω modal th√™m thu·ªëc
      document.querySelector('.add-button').addEventListener('click', function() {
        document.getElementById('addMedicineModal').style.display = 'block';
      });

      function loadMedicineData() {
        // Hi·ªÉn th·ªã loading
        tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        
        // G·ªçi API l·∫•y d·ªØ li·ªáu thu·ªëc
        fetch('./backend/api/thuoc/read.php')
          .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('API response:', data);
            console.log('S·ªë l∆∞·ª£ng thu·ªëc t·ª´ API:', data.records ? data.records.length : 0);
            if (data.records && data.records.length > 0) {
              allMedicines = data.records;
              displayMedicineData();
              updatePagination();
              console.log('ƒê√£ hi·ªÉn th·ªã', data.records.length, 'd√≤ng thu·ªëc');
            } else {
              tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu thu·ªëc</td></tr>';
            }
          })
          .catch(error => {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px; color: red;">L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message + '</td></tr>';
          });
      }

      function displayMedicineData() {
        tableBody.innerHTML = '';
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, allMedicines.length);
        const medicinesToShow = allMedicines.slice(startIndex, endIndex);
        medicinesToShow.forEach((medicine, index) => {
          const row = document.createElement('tr');
          
          // X·ª≠ l√Ω ·∫£nh t·ª´ database
          let imageSrc = './public/img/placeholder.png'; // ·∫£nh m·∫∑c ƒë·ªãnh
          if (medicine.anh && medicine.anh !== 'placeholder.png') {
            imageSrc = `./public/img/${medicine.anh}`;
          }
          
          // X·ª≠ l√Ω h·∫°n s·ª≠ d·ª•ng v√† m√£ l√¥
          const hanSuDung = medicine.han_su_dung || 'N/A';
          const maLo = medicine.ma_lo || 'N/A';
          
          row.innerHTML = `
            <td><img src="${imageSrc}" alt="${medicine.ten_thuoc}" onerror="this.src='./public/img/placeholder.png'" style="width: 50px; height: 50px; object-fit: cover;" /></td>
            <td>#${medicine.ma_thuoc.toString().padStart(3, '0')}</td>
            <td>${medicine.ten_thuoc}</td>
            <td>${medicine.don_vi}</td>
            <td>${parseInt(medicine.gia_nhap).toLocaleString()} VND</td>
            <td>${parseInt(medicine.gia_ban).toLocaleString()} VND</td>
            <td>${medicine.ngay_them}</td>
            <td>${medicine.sl_toi_thieu}</td>
            <td>${hanSuDung}</td>
            <td>${maLo}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="editMedicine(this)">S·ª≠a</button>
              <button class="btn btn-danger btn-sm" onclick="deleteMedicine(this)">X√≥a</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
        // N·∫øu kh√¥ng c√≥ thu·ªëc n√†o tr√™n trang n√†y
        if (medicinesToShow.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu thu·ªëc</td></tr>';
        }
      }

      function updatePagination() {
        const totalPages = Math.ceil(allMedicines.length / itemsPerPage) || 1;
        const pagination = document.getElementById('warehousePagination');
        pagination.innerHTML = '';
        // N√∫t Previous
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '<';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            displayMedicineData();
            updatePagination();
          }
        };
        pagination.appendChild(prevBtn);
        // C√°c n√∫t s·ªë trang
        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = i === currentPage ? 'active' : '';
          pageBtn.onclick = () => {
            currentPage = i;
            displayMedicineData();
            updatePagination();
          };
          pagination.appendChild(pageBtn);
        }
        // N√∫t Next
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            displayMedicineData();
            updatePagination();
          }
        };
        pagination.appendChild(nextBtn);
      }

      function closeModal() {
        document.getElementById('addMedicineModal').style.display = 'none';
        document.getElementById('addMedicineForm').reset();
      }

      function saveMedicine() {
        const medicineName = document.getElementById('medicineName').value;
        const medicineUnit = document.getElementById('medicineUnit').value;
        const importPrice = document.getElementById('importPrice').value;
        const salePrice = document.getElementById('salePrice').value;
        const minQuantity = document.getElementById('minQuantity').value;
        const imageFile = document.getElementById('medicineImage').files[0];
        const batchCode = document.getElementById('batchCode').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const addDate = document.getElementById('addDate').value;
        const soLuongLo = document.getElementById('soLuongLo') ? document.getElementById('soLuongLo').value : '';
        const trangThai = 'C√≤n h·∫°n';

        if (!medicineName || !medicineUnit || !importPrice || !salePrice) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
          return;
        }

        const formData = new FormData();
        formData.append('ten_thuoc', medicineName);
        formData.append('don_vi', medicineUnit);
        formData.append('gia_nhap', importPrice);
        formData.append('gia_ban', salePrice);
        formData.append('sl_toi_thieu', minQuantity || 10);
        if (imageFile) formData.append('anh', imageFile);
        formData.append('ma_lo', batchCode);
        formData.append('han_su_dung', expiryDate);
        formData.append('ngay_nhap', addDate);
        formData.append('so_luong', soLuongLo);
        formData.append('trang_thai', trangThai);

        fetch('./backend/api/thuoc/create.php', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.message && data.message.includes('th√†nh c√¥ng')) {
            alert('ƒê√£ th√™m thu·ªëc m·ªõi th√†nh c√¥ng!');
            closeModal();
            loadMedicineData();
          } else {
            alert('L·ªói khi th√™m thu·ªëc: ' + (data.message || 'Kh√¥ng r√µ nguy√™n nh√¢n'));
          }
        })
        .catch(err => {
          alert('L·ªói khi th√™m thu·ªëc: ' + err.message);
        });
      }

      // ƒê√≥ng modal khi click b√™n ngo√†i
      window.onclick = function(event) {
        const modal = document.getElementById('addMedicineModal');
        if (event.target == modal) {
          closeModal();
        }
      }

      // ƒê∆∞a c√°c function ra global scope ƒë·ªÉ onclick c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c
      window.closeModal = closeModal;
      window.saveMedicine = saveMedicine;
      window.editMedicine = editMedicine;
      window.closeEditModal = closeEditModal;
      window.updateMedicine = updateMedicine;
      window.deleteMedicine = deleteMedicine;

      // Function ch·ªânh s·ª≠a thu·ªëc
      function editMedicine(button) {
        const row = button.closest('tr');
        const cells = row.cells;
        
        // L·∫•y d·ªØ li·ªáu t·ª´ d√≤ng hi·ªán t·∫°i
        const medicineCode = cells[1].textContent;
        const medicineName = cells[2].textContent;
        const medicineUnit = cells[3].textContent;
        const importPrice = cells[4].textContent.replace(' VND', '').replace(/,/g, '');
        const salePrice = cells[5].textContent.replace(' VND', '').replace(/,/g, '');
        const addDate = cells[6].textContent === 'N/A' ? '' : cells[6].textContent;
        const minQuantity = cells[7].textContent === 'N/A' ? '' : cells[7].textContent;
        const expiryDate = cells[8].textContent === 'N/A' ? '' : cells[8].textContent;
        const batchCode = cells[9].textContent === 'N/A' ? '' : cells[9].textContent;

        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a
        document.getElementById('editMedicineCode').value = medicineCode;
        document.getElementById('editMedicineName').value = medicineName;
        document.getElementById('editMedicineUnit').value = medicineUnit;
        document.getElementById('editImportPrice').value = importPrice;
        document.getElementById('editSalePrice').value = salePrice;
        document.getElementById('editAddDate').value = addDate;
        document.getElementById('editMinQuantity').value = minQuantity;
        document.getElementById('editExpiryDate').value = expiryDate;
        document.getElementById('editBatchCode').value = batchCode;

        // L∆∞u reference ƒë·∫øn d√≤ng ƒëang ch·ªânh s·ª≠a
        window.editingRow = row;

        // Hi·ªán modal ch·ªânh s·ª≠a
        document.getElementById('editMedicineModal').style.display = 'block';
      }

      function closeEditModal() {
        document.getElementById('editMedicineModal').style.display = 'none';
        document.getElementById('editMedicineForm').reset();
        window.editingRow = null;
      }

      function updateMedicine() {
        if (!window.editingRow) return;
        const medicineCode = document.getElementById('editMedicineCode').value;
        const medicineName = document.getElementById('editMedicineName').value;
        const medicineUnit = document.getElementById('editMedicineUnit').value;
        const importPrice = document.getElementById('editImportPrice').value;
        const salePrice = document.getElementById('editSalePrice').value;
        const addDate = document.getElementById('editAddDate').value;
        const minQuantity = document.getElementById('editMinQuantity').value;
        const expiryDate = document.getElementById('editExpiryDate').value;
        const batchCode = document.getElementById('editBatchCode').value;
        const imageFile = document.getElementById('editMedicineImage').files[0];
        if (!medicineCode || !medicineName || !medicineUnit || !importPrice || !salePrice) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
          return;
        }
        const formData = new FormData();
        formData.append('ma_thuoc', medicineCode.replace('#', '').trim());
        formData.append('ten_thuoc', medicineName);
        formData.append('don_vi', medicineUnit);
        formData.append('gia_nhap', importPrice);
        formData.append('gia_ban', salePrice);
        formData.append('ngay_them', addDate);
        formData.append('sl_toi_thieu', minQuantity || 10);
        if (imageFile) formData.append('anh', imageFile);
        formData.append('han_su_dung', expiryDate);
        formData.append('ma_lo', batchCode);
        // N·∫øu c√≥ c√°c tr∆∞·ªùng ng√†y nh·∫≠p, s·ªë l∆∞·ª£ng l√¥ th√¨ g·ª≠i th√™m
        if (document.getElementById('editSoLuongLo')) formData.append('so_luong', document.getElementById('editSoLuongLo').value);
        if (document.getElementById('editAddDate')) formData.append('ngay_nhap', document.getElementById('editAddDate').value);
        fetch('./backend/api/thuoc/update.php', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.message && data.message.includes('th√†nh c√¥ng')) {
            alert('ƒê√£ c·∫≠p nh·∫≠t thu·ªëc th√†nh c√¥ng!');
            closeEditModal();
            loadMedicineData();
          } else {
            alert('L·ªói khi c·∫≠p nh·∫≠t thu·ªëc: ' + (data.message || 'Kh√¥ng r√µ nguy√™n nh√¢n'));
          }
        })
        .catch(err => {
          alert('L·ªói khi c·∫≠p nh·∫≠t thu·ªëc: ' + err.message);
        });
      }

      function deleteMedicine(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thu·ªëc n√†y?')) {
          const row = button.closest('tr');
          const maThuoc = row.cells[1].textContent.replace('#', '').trim();
          fetch('./backend/api/thuoc/delete.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ma_thuoc: maThuoc })
          })
          .then(res => res.json())
          .then(data => {
            if (data.message && data.message.includes('th√†nh c√¥ng')) {
              alert('ƒê√£ x√≥a thu·ªëc th√†nh c√¥ng!');
              loadMedicineData();
            } else {
              alert('L·ªói khi x√≥a thu·ªëc: ' + (data.message || 'Kh√¥ng r√µ nguy√™n nh√¢n'));
            }
          })
          .catch(err => {
            alert('L·ªói khi x√≥a thu·ªëc: ' + err.message);
          });
        }
      }
    });
  </script>
</html>
