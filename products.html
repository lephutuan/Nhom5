<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Ti·ªám Thu·ªëc T·ª± ƒê·ªông - S·∫£n Ph·∫©m</title>
    <link rel="stylesheet" href="./public/css/products.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="#">üíä PharmaCare</a>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="./home.html" onclick="setActive(this)">üè† Trang ch·ªß</a>
        </li>
        <li>
          <a href="./warehouse.html" onclick="setActive(this)">üì¶ Kho thu·ªëc</a>
        </li>
        <li>
          <a href="./products.html" onclick="setActive(this)">üìù ƒê∆°n thu·ªëc</a>
        </li>
        <li>
          <a href="./employees.html" onclick="setActive(this)">üë• Nh√¢n vi√™n</a>
        </li>
        <li><a href="./checkout.html" onclick="setActive(this)">üí≥ Thanh to√°n</a></li>
        <li>
          <a href="./reports.html" onclick="setActive(this)">üìà B√°o c√°o & Th·ªëng k√™</a>
        </li>
        <li>
          <a href="./warning.html" onclick="setActive(this)">ü§ñ Chatbox c·∫£nh b√°o</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main>
    <h1>ƒê∆°n thu·ªëc</h1>

    <!-- 1. Th√¥ng tin kh√°ch h√†ng v√† nh√¢n vi√™n -->
    <section class="form-section">
      <h2>Th√¥ng tin kh√°ch h√†ng v√† nh√¢n vi√™n</h2>
      <div class="customer-form">
        <div style="margin-bottom: 15px;">
          <label for="customerSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Kh√°ch h√†ng:</label>
          <select id="customerSelect">
            <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c render t·ª´ JS -->
          </select>
          <button class="btn btn-secondary" id="btnAddCustomer">+ Th√™m kh√°ch h√†ng m·ªõi</button>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label for="employeeSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Nh√¢n vi√™n th·ª±c hi·ªán:</label>
          <select id="employeeSelect">
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c render t·ª´ JS -->
          </select>
        </div>
        
        <!-- Form th√™m kh√°ch h√†ng m·ªõi, ·∫©n m·∫∑c ƒë·ªãnh -->
        <div id="addCustomerForm" style="display:none; gap: 8px; align-items: center; margin-top: 8px;">
          <input type="text" id="newCustomerName" placeholder="T√™n kh√°ch h√†ng" style="width: 180px;" />
          <input type="text" id="newCustomerPhone" placeholder="SƒêT" style="width: 120px;" />
          <input type="text" id="newCustomerAllergy" placeholder="D·ªã ·ª©ng (n·∫øu c√≥)" style="width: 180px;" />
          <button class="btn btn-primary" id="btnSaveCustomer"><i class="fa fa-save"></i> L∆∞u</button>
          <button class="btn btn-danger" id="btnCancelAddCustomer"><i class="fa fa-times"></i> H·ªßy</button>
        </div>
        
        <div class="customer-info" id="customerInfo">
          <!-- T√™n, sƒët, d·ªã ·ª©ng s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y -->
        </div>
      </div>
    </section>

    <!-- 2. Th√™m thu·ªëc v√†o ƒë∆°n -->
    <section class="form-section">
      <h2>Th√™m thu·ªëc v√†o ƒë∆°n</h2>
      <div class="medicine-form">
        <input type="text" placeholder="T√¨m thu·ªëc..." id="medicineSearch" />
        <input type="text" placeholder="Li·ªÅu l∆∞·ª£ng" id="dose" />
        <input type="number" placeholder="S·ªë ng√†y" id="days" />
        <input type="number" placeholder="S·ªë l∆∞·ª£ng" id="quantity" />
        <button class="btn btn-primary" onclick="addMedicine()">+ Th√™m thu·ªëc</button>
      </div>
    </section>

    <!-- 3. Danh s√°ch thu·ªëc trong ƒë∆°n -->
    <section class="form-section">
      <h2>Danh s√°ch thu·ªëc</h2>
      <table class="medicine-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>T√™n thu·ªëc</th>
            <th>Li·ªÅu d√πng</th>
            <th>S·ªë ng√†y</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>X√≥a</th>
          </tr>
        </thead>
        <tbody id="medicineList">
          <!-- JS render thu·ªëc t·∫°i ƒë√¢y -->
        </tbody>
      </table>
    </section>

    <!-- 4. H√†nh ƒë·ªông -->
    <section class="form-section">
      <button class="btn btn-success" onclick="submitPrescription()">üíæ L∆∞u ƒë∆°n thu·ªëc</button>
      <button class="btn btn-danger" onclick="cancelPrescription()">‚ùå H·ªßy</button>
    </section>
  </main>

  </body>
  <script src="./public/js/navbar.js"></script>
  <script src="./public/js/sidebar.js"></script>
  <script src="./backend/public/js/config.js"></script>
  <script src="./backend/public/js/api.js"></script>
  <script>
    // Kh·ªüi t·∫°o d·ªØ li·ªáu
    let thuocList = [];
    let khachHangList = [];
    let nhanVienList = [];
    let selectedMedicines = [];
    let selectedCustomer = null;
    let selectedEmployee = null;

    // Load d·ªØ li·ªáu khi trang load
    document.addEventListener('DOMContentLoaded', async function() {
      await loadData();
      setupEventListeners();
    });

    // Load t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn thi·∫øt
    async function loadData() {
      try {
        UI.showLoading();
        
        const [thuocData, khachHangData, nhanVienData] = await Promise.all([
          API.getThuoc(),
          API.getKhachHang(),
          API.getNhanVien()
        ]);

        thuocList = thuocData.records;
        khachHangList = khachHangData.records;
        nhanVienList = nhanVienData.records;

        populateCustomerSelect();
        populateEmployeeSelect();
        setupMedicineSearch();
        
      } catch (error) {
        UI.showMessage('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Populate customer select
    function populateCustomerSelect() {
      const select = document.getElementById('customerSelect');
      select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>';
      
      khachHangList.forEach(kh => {
        const option = document.createElement('option');
        option.value = kh.ma_kh;
        option.textContent = `${kh.ten_kh} - ${kh.sdt}`;
        select.appendChild(option);
      });
    }

    // Populate employee select
    function populateEmployeeSelect() {
      const select = document.getElementById('employeeSelect');
      select.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
      
      nhanVienList.forEach(nv => {
        const option = document.createElement('option');
        option.value = nv.ma_nv;
        option.textContent = `${nv.ten_nv} - ${nv.chuc_vu}`;
        select.appendChild(option);
      });
    }

    // Setup medicine search
    function setupMedicineSearch() {
      const searchInput = document.getElementById('medicineSearch');
      const datalist = document.createElement('datalist');
      datalist.id = 'medicineOptions';
      
      thuocList.forEach(thuoc => {
        const option = document.createElement('option');
        option.value = thuoc.ten_thuoc;
        option.dataset.maThuoc = thuoc.ma_thuoc;
        option.dataset.giaBan = thuoc.gia_ban;
        datalist.appendChild(option);
      });
      
      searchInput.setAttribute('list', 'medicineOptions');
      document.body.appendChild(datalist);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Customer select change
      document.getElementById('customerSelect').addEventListener('change', function() {
        const maKh = this.value;
        if (maKh) {
          selectedCustomer = khachHangList.find(kh => kh.ma_kh == maKh);
          displayCustomerInfo(selectedCustomer);
        } else {
          selectedCustomer = null;
          document.getElementById('customerInfo').innerHTML = '';
        }
      });

      // Employee select change
      document.getElementById('employeeSelect').addEventListener('change', function() {
        const maNv = this.value;
        if (maNv) {
          selectedEmployee = nhanVienList.find(nv => nv.ma_nv == maNv);
        } else {
          selectedEmployee = null;
        }
      });

      // N√∫t th√™m kh√°ch h√†ng m·ªõi
      document.getElementById('btnAddCustomer').addEventListener('click', function() {
        this.style.display = 'none';
        document.getElementById('addCustomerForm').style.display = 'flex';
      });
      // N√∫t h·ªßy th√™m kh√°ch h√†ng m·ªõi
      document.getElementById('btnCancelAddCustomer').addEventListener('click', function() {
        document.getElementById('addCustomerForm').style.display = 'none';
        document.getElementById('btnAddCustomer').style.display = 'inline-block';
        document.getElementById('newCustomerName').value = '';
        document.getElementById('newCustomerPhone').value = '';
        document.getElementById('newCustomerAllergy').value = '';
      });
      // N√∫t l∆∞u kh√°ch h√†ng m·ªõi
      document.getElementById('btnSaveCustomer').addEventListener('click', async function() {
        const ten_kh = document.getElementById('newCustomerName').value.trim();
        const sdt = document.getElementById('newCustomerPhone').value.trim();
        const di_ung = document.getElementById('newCustomerAllergy').value.trim();
        if (!ten_kh || !sdt) {
          UI.showMessage('Vui l√≤ng nh·∫≠p t√™n v√† s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng!', 'error');
          return;
        }
        try {
          UI.showLoading();
          // G·ªçi API t·∫°o kh√°ch h√†ng m·ªõi
          const res = await API.createKhachHang({ ten_kh, sdt, di_ung });
          if (res && res.ma_kh) {
            khachHangList.push({ ma_kh: res.ma_kh, ten_kh, sdt, di_ung });
            populateCustomerSelect();
            document.getElementById('customerSelect').value = res.ma_kh;
            selectedCustomer = khachHangList.find(kh => kh.ma_kh == res.ma_kh);
            displayCustomerInfo(selectedCustomer);
            document.getElementById('addCustomerForm').style.display = 'none';
            document.getElementById('btnAddCustomer').style.display = 'inline-block';
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerAllergy').value = '';
            UI.showMessage('ƒê√£ th√™m kh√°ch h√†ng m·ªõi!', 'success');
          } else {
            throw new Error('Kh√¥ng th·ªÉ th√™m kh√°ch h√†ng m·ªõi!');
          }
        } catch (err) {
          UI.showMessage('L·ªói khi th√™m kh√°ch h√†ng m·ªõi: ' + err.message, 'error');
        } finally {
          UI.hideLoading();
        }
      });

      // Medicine search
      document.getElementById('medicineSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredMedicines = thuocList.filter(thuoc => 
          thuoc.ten_thuoc.toLowerCase().includes(searchTerm)
        );
        
        if (filteredMedicines.length === 1) {
          const thuoc = filteredMedicines[0];
          this.dataset.selectedMaThuoc = thuoc.ma_thuoc;
          this.dataset.selectedGiaBan = thuoc.gia_ban;
        }
      });
    }

    // Display customer info
    function displayCustomerInfo(customer) {
      const infoDiv = document.getElementById('customerInfo');
      infoDiv.innerHTML = `
        <div class="customer-details">
          <p><strong>T√™n:</strong> ${customer.ten_kh}</p>
          <p><strong>SƒêT:</strong> ${customer.sdt}</p>
          <p><strong>D·ªã ·ª©ng:</strong> ${customer.di_ung}</p>
        </div>
      `;
    }



    // Add medicine to prescription
    function addMedicine() {
      const searchInput = document.getElementById('medicineSearch');
      const doseInput = document.getElementById('dose');
      const daysInput = document.getElementById('days');
      const quantityInput = document.getElementById('quantity');

      const maThuoc = searchInput.dataset.selectedMaThuoc;
      const tenThuoc = searchInput.value;
      const lieuLuong = doseInput.value;
      const soNgay = parseInt(daysInput.value);
      const soLuong = parseInt(quantityInput.value);

      if (!maThuoc || !lieuLuong || !soNgay || !soLuong) {
        UI.showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin thu·ªëc', 'error');
        return;
      }

      const medicine = {
        ma_thuoc: maThuoc,
        ten_thuoc: tenThuoc,
        lieu_luong: lieuLuong,
        so_ngay: soNgay,
        so_luong: soLuong
      };

      selectedMedicines.push(medicine);
      displayMedicineList();
      clearMedicineForm();
    }

    // Display medicine list
    function displayMedicineList() {
      const tbody = document.getElementById('medicineList');
      tbody.innerHTML = '';

      selectedMedicines.forEach((medicine, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${medicine.ten_thuoc}</td>
          <td>${medicine.lieu_luong}</td>
          <td>${medicine.so_ngay}</td>
          <td>${medicine.so_luong}</td>
          <td><button onclick="removeMedicine(${index})" class="btn btn-danger btn-sm">X√≥a</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // Remove medicine
    function removeMedicine(index) {
      selectedMedicines.splice(index, 1);
      displayMedicineList();
    }

    // Clear medicine form
    function clearMedicineForm() {
      document.getElementById('medicineSearch').value = '';
      document.getElementById('dose').value = '';
      document.getElementById('days').value = '';
      document.getElementById('quantity').value = '';
      delete document.getElementById('medicineSearch').dataset.selectedMaThuoc;
      delete document.getElementById('medicineSearch').dataset.selectedGiaBan;
    }

    // Submit prescription
    async function submitPrescription() {
      if (!selectedCustomer) {
        UI.showMessage('Vui l√≤ng ch·ªçn kh√°ch h√†ng', 'error');
        return;
      }

      if (!selectedEmployee) {
        UI.showMessage('Vui l√≤ng ch·ªçn nh√¢n vi√™n th·ª±c hi·ªán', 'error');
        return;
      }

      if (selectedMedicines.length === 0) {
        UI.showMessage('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt lo·∫°i thu·ªëc', 'error');
        return;
      }

      try {
        UI.showLoading();

        // T·∫°o ƒë∆°n thu·ªëc
        const donThuocData = {
          ma_kh: selectedCustomer.ma_kh,
          ma_nv: selectedEmployee.ma_nv,
          ngay_tao: new Date().toISOString().slice(0, 19).replace('T', ' '),
          da_thanh_toan: 'Ch∆∞a thanh to√°n'
        };

        const response = await API.createDonThuoc(donThuocData);
        
        if (response.ma_don) {
          // T·∫°o chi ti·∫øt ƒë∆°n thu·ªëc
          const chiTietData = {
            ma_don: response.ma_don,
            chi_tiet_list: selectedMedicines.map(medicine => ({
              ma_thuoc: medicine.ma_thuoc,
              lieu_luong: medicine.lieu_luong,
              so_ngay: medicine.so_ngay,
              so_luong: medicine.so_luong
            }))
          };

          await API.createChiTietDonThuoc(chiTietData);
          
          UI.showMessage('ƒê∆°n thu·ªëc ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
          resetForm();
        }

      } catch (error) {
        UI.showMessage('L·ªói khi t·∫°o ƒë∆°n thu·ªëc: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Cancel prescription
    function cancelPrescription() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n thu·ªëc n√†y?')) {
        resetForm();
      }
    }

    // Reset form
    function resetForm() {
      selectedCustomer = null;
      selectedEmployee = null;
      selectedMedicines = [];
      document.getElementById('customerSelect').value = '';
      document.getElementById('employeeSelect').value = '';
      document.getElementById('customerInfo').innerHTML = '';
      document.getElementById('medicineList').innerHTML = '';
      clearMedicineForm();
    }
  </script>
</html>
