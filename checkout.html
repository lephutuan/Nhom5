<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh ToÃ¡n</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link rel="stylesheet" href="./public/css/checkout.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="#">ğŸ’Š PharmaCare</a>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="./home.html" onclick="setActive(this)">ğŸ  Trang chá»§</a>
        </li>
        <li>
          <a href="./warehouse.html" onclick="setActive(this)">ğŸ“¦ Kho thuá»‘c</a>
        </li>
        <li>
          <a href="./products.html" onclick="setActive(this)">ğŸ“ ÄÆ¡n thuá»‘c</a>
        </li>
        <li>
          <a href="./employees.html" onclick="setActive(this)">ğŸ‘¥ NhÃ¢n viÃªn</a>
        </li>
        <li><a href="./checkout.html" onclick="setActive(this)">ğŸ’³ Thanh toÃ¡n</a></li>
        <li>
          <a href="./reports.html" onclick="setActive(this)">ğŸ“ˆ BÃ¡o cÃ¡o & Thá»‘ng kÃª</a>
        </li>
        <li>
          <a href="./warning.html" onclick="setActive(this)">ğŸ¤– Chatbox cáº£nh bÃ¡o</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="invoice-container">
        <h1>Thanh toÃ¡n hÃ³a Ä‘Æ¡n</h1>
        <div class="invoice-details">
          <p>MÃ£ Ä‘Æ¡n: </p>
          <p>KhÃ¡ch hÃ ng: </p>
          <p>NhÃ¢n viÃªn: </p>
        </div>
        <table class="invoice-table">
          <thead>
            <tr>
              <th>TÃªn thuá»‘c</th>
              <th>Sá»‘ lÆ°á»£ng</th>
              <th>ÄÆ¡n giÃ¡</th>
              <th>ThÃ nh tiá»n</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
        <div class="payment-options">
          <label><input type="radio" name="payment" checked /> Tiá»n máº·t</label>
          <label><input type="radio" name="payment" /> Chuyá»ƒn khoáº£n</label>
          <label><input type="radio" name="payment" /> VÃ­ Ä‘iá»‡n tá»­</label>
        </div>
        <div class="total-amount">Tá»”NG Cá»˜NG: 70.000</div>
        <a href="#" class="btn">XÃ¡c nháº­n vÃ  táº¡o hÃ³a Ä‘Æ¡n</a>
        <div class="footer-note">
          * HÃ³a Ä‘Æ¡n sáº½ Ä‘Æ°á»£c lÆ°u vÃ  gá»­i Ä‘áº¿n ngay sau khi xÃ¡c nháº­n
        </div>
      </div>
    </main>
  </body>
  <script src="./public/js/navbar.js"></script>
  <script src="./public/js/sidebar.js"></script>
  <script src="./backend/public/js/api.js"></script>
  <script>
    let donThuocList = [];
    let selectedDonThuoc = null;

    // Load dá»¯ liá»‡u khi trang load
    document.addEventListener('DOMContentLoaded', async function() {
      await loadDonThuoc();
    });

    // Load danh sÃ¡ch Ä‘Æ¡n thuá»‘c chÆ°a thanh toÃ¡n
    async function loadDonThuoc() {
      try {
        UI.showLoading();
        const data = await API.getDonThuoc();
        donThuocList = data.records.filter(don => don.da_thanh_toan === 'ChÆ°a thanh toÃ¡n');
        displayDonThuocSelect();
      } catch (error) {
        UI.showMessage('Lá»—i khi táº£i danh sÃ¡ch Ä‘Æ¡n thuá»‘c: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Hiá»ƒn thá»‹ select Ä‘Æ¡n thuá»‘c
    function displayDonThuocSelect() {
      const container = document.querySelector('.invoice-details');
      const selectHtml = `
        <div class="don-thuoc-select">
          <label for="donThuocSelect">Chá»n Ä‘Æ¡n thuá»‘c:</label>
          <select id="donThuocSelect" onchange="loadDonThuocDetails()">
            <option value="">-- Chá»n Ä‘Æ¡n thuá»‘c --</option>
            ${donThuocList.map(don => `
              <option value="${don.ma_don}">ÄÆ¡n #${don.ma_don} - ${don.ten_kh}</option>
            `).join('')}
          </select>
        </div>
      `;
      
      container.innerHTML = selectHtml + container.innerHTML;
    }

    // Load chi tiáº¿t Ä‘Æ¡n thuá»‘c
    async function loadDonThuocDetails() {
      const maDon = document.getElementById('donThuocSelect').value;
      if (!maDon) {
        clearInvoiceDetails();
        return;
      }

      selectedDonThuoc = donThuocList.find(don => don.ma_don == maDon);
      if (selectedDonThuoc) {
        updateInvoiceDetails();
      }
    }

    // Cáº­p nháº­t thÃ´ng tin hÃ³a Ä‘Æ¡n
    function updateInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      detailsDiv.innerHTML = `
        <p>MÃ£ Ä‘Æ¡n: #${selectedDonThuoc.ma_don}</p>
        <p>KhÃ¡ch hÃ ng: ${selectedDonThuoc.ten_kh}</p>
        <p>NhÃ¢n viÃªn: ${selectedDonThuoc.ten_nv}</p>
        <p>NgÃ y táº¡o: ${UI.formatDate(selectedDonThuoc.ngay_tao)}</p>
      `;

      // Táº¡m thá»i hiá»ƒn thá»‹ dá»¯ liá»‡u máº«u cho thuá»‘c
      displayInvoiceItems();
    }

    // Hiá»ƒn thá»‹ danh sÃ¡ch thuá»‘c trong hÃ³a Ä‘Æ¡n
    function displayInvoiceItems() {
      const tbody = document.querySelector('.invoice-table tbody');
      // Táº¡m thá»i sá»­ dá»¥ng dá»¯ liá»‡u máº«u
      tbody.innerHTML = `
        <tr>
          <td>Paracetamol 500mg</td>
          <td>2</td>
          <td>3.000Ä‘</td>
          <td>6.000Ä‘</td>
        </tr>
        <tr>
          <td>Amoxicillin 500mg</td>
          <td>1</td>
          <td>2.500Ä‘</td>
          <td>2.500Ä‘</td>
        </tr>
      `;

      // Cáº­p nháº­t tá»•ng tiá»n
      document.querySelector('.total-amount').textContent = 'Tá»”NG Cá»˜NG: 8.500Ä‘';
    }

    // XÃ³a thÃ´ng tin hÃ³a Ä‘Æ¡n
    function clearInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      detailsDiv.innerHTML = `
        <p>MÃ£ Ä‘Æ¡n: --</p>
        <p>KhÃ¡ch hÃ ng: --</p>
        <p>NhÃ¢n viÃªn: --</p>
      `;

      const tbody = document.querySelector('.invoice-table tbody');
      tbody.innerHTML = '';

      document.querySelector('.total-amount').textContent = 'Tá»”NG Cá»˜NG: 0Ä‘';
    }

    // XÃ¡c nháº­n thanh toÃ¡n
    async function confirmPayment() {
      if (!selectedDonThuoc) {
        UI.showMessage('Vui lÃ²ng chá»n Ä‘Æ¡n thuá»‘c', 'error');
        return;
      }

      const paymentMethod = document.querySelector('input[name="payment"]:checked').value || 'Tiá»n máº·t';

      try {
        UI.showLoading();
        
        // Cáº­p nháº­t tráº¡ng thÃ¡i thanh toÃ¡n
        await API.updateDonThuoc(selectedDonThuoc.ma_don, {
          ma_kh: selectedDonThuoc.ma_kh,
          ma_nv: selectedDonThuoc.ma_nv,
          ngay_tao: selectedDonThuoc.ngay_tao,
          da_thanh_toan: 'ÄÃ£ thanh toÃ¡n'
        });

        UI.showMessage('Thanh toÃ¡n thÃ nh cÃ´ng!', 'success');
        
        // Reload danh sÃ¡ch Ä‘Æ¡n thuá»‘c
        await loadDonThuoc();
        clearInvoiceDetails();
        
      } catch (error) {
        UI.showMessage('Lá»—i khi thanh toÃ¡n: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // ThÃªm event listener cho button xÃ¡c nháº­n
    document.addEventListener('DOMContentLoaded', function() {
      const confirmBtn = document.querySelector('.btn');
      if (confirmBtn) {
        confirmBtn.onclick = confirmPayment;
      }
    });
  </script>
</html>
