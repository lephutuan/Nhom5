<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Toán</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link rel="stylesheet" href="./public/css/checkout.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </div>
      <div class="logo">
        <a href="#">💊 PharmaCare</a>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li>
          <a href="./home.html" onclick="setActive(this)">🏠 Trang chủ</a>
        </li>
        <li>
          <a href="./warehouse.html" onclick="setActive(this)">📦 Kho thuốc</a>
        </li>
        <li>
          <a href="./products.html" onclick="setActive(this)">📝 Đơn thuốc</a>
        </li>
        <li>
          <a href="./employees.html" onclick="setActive(this)">👥 Nhân viên</a>
        </li>
        <li><a href="./checkout.html" onclick="setActive(this)">💳 Thanh toán</a></li>
        <li>
          <a href="./reports.html" onclick="setActive(this)">📈 Báo cáo & Thống kê</a>
        </li>
        <li>
          <a href="./warning.html" onclick="setActive(this)">🤖 Chatbox cảnh báo</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="invoice-container">
        <h1>Thanh toán hóa đơn</h1>
        <div class="invoice-details">
          <p>Mã đơn: </p>
          <p>Khách hàng: </p>
          <p>Nhân viên: </p>
        </div>
        <table class="invoice-table">
          <thead>
            <tr>
              <th>Tên thuốc</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
        <div class="payment-options">
          <label><input type="radio" name="payment" checked /> Tiền mặt</label>
          <label><input type="radio" name="payment" /> Chuyển khoản</label>
          <label><input type="radio" name="payment" /> Ví điện tử</label>
        </div>
        <div class="total-amount">TỔNG CỘNG: 70.000</div>
        <a href="#" class="btn">Xác nhận và tạo hóa đơn</a>
        <div class="footer-note">
          * Hóa đơn sẽ được lưu và gửi đến ngay sau khi xác nhận
        </div>
      </div>
    </main>
  </body>
  <script src="./public/js/navbar.js"></script>
  <script src="./public/js/sidebar.js"></script>
  <script src="./backend/public/js/api.js"></script>
  <script>
    let donThuocList = [];
    let selectedDonThuoc = null;

    // Load dữ liệu khi trang load
    document.addEventListener('DOMContentLoaded', async function() {
      await loadDonThuoc();
    });

    // Load danh sách đơn thuốc chưa thanh toán
    async function loadDonThuoc() {
      try {
        UI.showLoading();
        const data = await API.getDonThuoc();
        donThuocList = data.records.filter(don => don.da_thanh_toan === 'Chưa thanh toán');
        displayDonThuocSelect();
      } catch (error) {
        UI.showMessage('Lỗi khi tải danh sách đơn thuốc: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Hiển thị select đơn thuốc
    function displayDonThuocSelect() {
      const container = document.querySelector('.invoice-details');
      const selectHtml = `
        <div class="don-thuoc-select">
          <label for="donThuocSelect">Chọn đơn thuốc:</label>
          <select id="donThuocSelect" onchange="loadDonThuocDetails()">
            <option value="">-- Chọn đơn thuốc --</option>
            ${donThuocList.map(don => `
              <option value="${don.ma_don}">Đơn #${don.ma_don} - ${don.ten_kh}</option>
            `).join('')}
          </select>
        </div>
      `;
      
      container.innerHTML = selectHtml + container.innerHTML;
    }

    // Load chi tiết đơn thuốc
    async function loadDonThuocDetails() {
      const maDon = document.getElementById('donThuocSelect').value;
      if (!maDon) {
        clearInvoiceDetails();
        return;
      }

      selectedDonThuoc = donThuocList.find(don => don.ma_don == maDon);
      if (selectedDonThuoc) {
        updateInvoiceDetails();
      }
    }

    // Cập nhật thông tin hóa đơn
    function updateInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      detailsDiv.innerHTML = `
        <p>Mã đơn: #${selectedDonThuoc.ma_don}</p>
        <p>Khách hàng: ${selectedDonThuoc.ten_kh}</p>
        <p>Nhân viên: ${selectedDonThuoc.ten_nv}</p>
        <p>Ngày tạo: ${UI.formatDate(selectedDonThuoc.ngay_tao)}</p>
      `;

      // Tạm thời hiển thị dữ liệu mẫu cho thuốc
      displayInvoiceItems();
    }

    // Hiển thị danh sách thuốc trong hóa đơn
    function displayInvoiceItems() {
      const tbody = document.querySelector('.invoice-table tbody');
      // Tạm thời sử dụng dữ liệu mẫu
      tbody.innerHTML = `
        <tr>
          <td>Paracetamol 500mg</td>
          <td>2</td>
          <td>3.000đ</td>
          <td>6.000đ</td>
        </tr>
        <tr>
          <td>Amoxicillin 500mg</td>
          <td>1</td>
          <td>2.500đ</td>
          <td>2.500đ</td>
        </tr>
      `;

      // Cập nhật tổng tiền
      document.querySelector('.total-amount').textContent = 'TỔNG CỘNG: 8.500đ';
    }

    // Xóa thông tin hóa đơn
    function clearInvoiceDetails() {
      const detailsDiv = document.querySelector('.invoice-details');
      detailsDiv.innerHTML = `
        <p>Mã đơn: --</p>
        <p>Khách hàng: --</p>
        <p>Nhân viên: --</p>
      `;

      const tbody = document.querySelector('.invoice-table tbody');
      tbody.innerHTML = '';

      document.querySelector('.total-amount').textContent = 'TỔNG CỘNG: 0đ';
    }

    // Xác nhận thanh toán
    async function confirmPayment() {
      if (!selectedDonThuoc) {
        UI.showMessage('Vui lòng chọn đơn thuốc', 'error');
        return;
      }

      const paymentMethod = document.querySelector('input[name="payment"]:checked').value || 'Tiền mặt';

      try {
        UI.showLoading();
        
        // Cập nhật trạng thái thanh toán
        await API.updateDonThuoc(selectedDonThuoc.ma_don, {
          ma_kh: selectedDonThuoc.ma_kh,
          ma_nv: selectedDonThuoc.ma_nv,
          ngay_tao: selectedDonThuoc.ngay_tao,
          da_thanh_toan: 'Đã thanh toán'
        });

        UI.showMessage('Thanh toán thành công!', 'success');
        
        // Reload danh sách đơn thuốc
        await loadDonThuoc();
        clearInvoiceDetails();
        
      } catch (error) {
        UI.showMessage('Lỗi khi thanh toán: ' + error.message, 'error');
      } finally {
        UI.hideLoading();
      }
    }

    // Thêm event listener cho button xác nhận
    document.addEventListener('DOMContentLoaded', function() {
      const confirmBtn = document.querySelector('.btn');
      if (confirmBtn) {
        confirmBtn.onclick = confirmPayment;
      }
    });
  </script>
</html>
